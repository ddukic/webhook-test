# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm install

      # Runs a single command using the runners shell
      - name: Run a one-line script
        run: node cypress run --browser chrome

      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.

      # Read results.json
      - id: set_var
        run: |
          content=`cat results.json`
          # the following lines are only required for multi line json
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"
          # end of optional handling for multi line json
          echo "::set-output name=results::$content"
          
      - name: Upload screenshots
        uses: actions/upload-artifact@v3
        with:
          name: screenshots
          path: cypress/screenshots
          if-no-files-found: ignore

      - name: Log me
        run: echo "${{toJSON(github)}}"

      # Slack integration
      # - name: Slack notification success
      #   if: success()
      #   env:
      #     SLACK_WEBHOOK: ${{ secrets.SLACK_AT_NOTIFICATIONS }}
      #     SLACK_USERNAME: cypress-e2e-tests
      #   uses: Ilshidur/action-slack@2.1.0
      #   with:
      #     args: |
      #       :green-circle: *Test passed:* <https://github.com/ddukic/webhook-test/actions/runs/{{ GITHUB_RUN_ID }}| ${{ github.job }}>
      #       - Tests run: *${{fromJson(steps.set_var.outputs.results).totalTests}}*
      #       - Tests passed: *${{fromJson(steps.set_var.outputs.results).totalPassed}}*
      #       - Tests failed: *${{fromJson(steps.set_var.outputs.results).totalFailed}}*
      #       - Skipped tests: *${{fromJson(steps.set_var.outputs.results).totalPending}}*